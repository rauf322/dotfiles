#!/usr/bin/env bash

###############################################################################
# ENV
###############################################################################

if [ -f "$HOME/.config/yabai/yabai_env.sh" ]; then
  source "$HOME/.config/yabai/yabai_env.sh"
fi

###############################################################################
# SCRIPTING ADDITION
###############################################################################

sudo yabai --load-sa
yabai -m signal --add event=dock_did_restart action="sudo yabai --load-sa"

# Prevent macOS space auto-reordering
defaults write com.apple.dock mru-spaces -bool false

###############################################################################
# EXCLUDED APPS (SAFE)
###############################################################################

yabai -m rule --add app="^${apps_mgoff_normal}$" manage=off
yabai -m rule --add app="^${apps_mgoff_below}$" manage=off sub-layer=below
yabai -m rule --add app="^${apps_mgoff_above}$" manage=off sub-layer=above

# Float on current space + move to wherever you are when it opens
yabai -m rule --add app="^OpenVPN Connect$" manage=off
yabai -m signal --add event=window_created app="^OpenVPN Connect$" action="yabai -m window \$YABAI_WINDOW_ID --space mouse && yabai -m window --focus \$YABAI_WINDOW_ID"

###############################################################################
# ÃœBERSICHT REFRESH (SAFE)
###############################################################################

osascript -e 'tell application id "tracesOf.Uebersicht" to refresh' >/dev/null 2>&1 || true

###############################################################################
# SKETCHYBAR PADDING
###############################################################################

if command -v sketchybar &>/dev/null; then
  display_resolution="$(system_profiler SPDisplaysDataType | grep Resolution)"

  if [[ "$display_resolution" == *"3648 x 2052"* ]]; then
    yabai -m config top_padding 42
    yabai -m config bottom_padding 10
    yabai -m config left_padding 10
    yabai -m config right_padding 10
  elif [[ "$display_resolution" == *"3024 x 1964 Retina"* ]]; then
    yabai -m config top_padding 5
    yabai -m config bottom_padding 5
    yabai -m config left_padding 5
    yabai -m config right_padding 5
  else
    yabai -m config top_padding 2
    yabai -m config bottom_padding 0
  fi
else
  yabai -m config top_padding 2
  yabai -m config bottom_padding 0
fi

###############################################################################
# CORE SETTINGS
###############################################################################

yabai -m config \
  layout bsp \
  focus_follows_mouse off \
  mouse_follows_focus on \
  window_origin_display default \
  window_placement second_child \
  window_zoom_persist on \
  window_shadow off \
  auto_balance off \
  split_ratio 0.50 \
  window_gap 10

###############################################################################
# SKETCHYBAR SIGNAL
###############################################################################

yabai -m signal --add event=space_changed \
  action="sketchybar --trigger aerospace_workspace_change FOCUSED_WORKSPACE=\$YABAI_SPACE_ID PREV_WORKSPACE=\$YABAI_RECENT_SPACE_ID"

###############################################################################
# SPACES
###############################################################################

for i in {1..10}; do
  yabai -m space $i --label desk$i
done

# Special layout overrides
yabai -m space desk3 --layout bsp
yabai -m space desk5 --layout bsp
yabai -m space desk5 --mirror y-axis

###############################################################################
# MULTI-MONITOR SAFE LOGIC
###############################################################################

displays_json="$(yabai -m query --displays)"
display_count="$(echo "$displays_json" | jq 'length')"

if [[ "$display_count" -gt 1 ]]; then
  first_space_index="$(
    echo "$displays_json" |
      jq 'min_by(.spaces | length) | .spaces[0]'
  )"

  yabai -m config --space "$first_space_index" top_padding 5
fi

###############################################################################
# APP RULES (NO GLOBAL CATCH-ALL RULE)
###############################################################################

# Browsers
yabai -m rule --add app="^Brave Browser$" space=desk1
yabai -m rule --add app="^[Zz]en" space=desk1
yabai -m rule --add app="^Google Chrome$" space=desk2

# Dev
yabai -m rule --add app="^[Gg]hostty$" space=desk3
yabai -m rule --add app="^RunJs$" space=desk3
yabai -m rule --add app="^[Cc]ursor$" space=desk3
yabai -m rule --add app="^Zed$" space=desk3
yabai -m rule --add app="^Code$" space=desk3

# Productivity
yabai -m rule --add app="^Slack$" space=desk4
yabai -m rule --add app="^Excalidraw$" space=desk4
yabai -m rule --add app="^Spark$" space=desk4
yabai -m rule --add app="^GoodNotes$" space=desk4
yabai -m rule --add app="^Obsidian$" space=desk4
yabai -m rule --add app="^IINA$" manage=off space=desk4

# Chat
yabai -m rule --add app="^[Dd]iscord$" space=desk7
yabai -m rule --add app="^Telegram$" space=desk7

# Files
yabai -m rule --add app="^Finder$" manage=off space=desk8

# Music
yabai -m rule --add app="^Spotify$" space=desk9

yabai -m rule --apply
